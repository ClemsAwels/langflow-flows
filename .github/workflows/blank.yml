name: Manage Langflow Flows

on:
  push:
    branches:
      - main

jobs:
  detect_changes:
    runs-on: self-hosted
    outputs:
      all_changes: ${{ steps.changed_files.outputs.all_changes }}
      flows_changes: ${{ steps.changed_files.outputs.flows_changes }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Get changed files and filter flows/
        id: changed_files
        run: |
          echo "🔍 Getting list of changed files..."

          CHANGES=$(git diff --name-status ${{ github.event.before }} ${{ github.sha }})
          echo "$CHANGES"

          FILES=$(echo "$CHANGES" | cut -f2)
          echo "📝 Changed files:"
          echo "$FILES"

          FLOWS_FILES=$(echo "$FILES" | grep '^flows/' || true)
          echo "📁 Files in flows/:"
          echo "$FLOWS_FILES"

          # Échapper les retours à la ligne
          ESCAPED_ALL=$(echo "$FILES" | sed ':a;N;$!ba;s/\n/\\n/g')
          ESCAPED_FLOWS=$(echo "$FLOWS_FILES" | sed ':a;N;$!ba;s/\n/\\n/g')

          # Utilisation correcte de GITHUB_OUTPUT
          {
            echo "all_changes=$ESCAPED_ALL"
            echo "flows_changes=$ESCAPED_FLOWS"
          } >> "$GITHUB_OUTPUT"

      - name: Debug output
        run: |
          echo "All changes: ${{ steps.changed_files.outputs.all_changes }}"
          echo "Flows changes: ${{ steps.changed_files.outputs.flows_changes }}"
